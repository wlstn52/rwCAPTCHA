<!DOCTYPE html>
<html>
  <head>
    <style>
      #grid {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        gap: 10px;
      }
      .tile {
        width: 100px;
        height: 100px;
        border: 2px solid gray;
        background-size: cover;
        background-position: center;
        cursor: pointer;
        position: relative;
      }
      .selected {
        border: 2px solid green;
        box-shadow: inset 0 0 0 4px rgba(0, 255, 0, 0.5);
      }
      #question {
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="question"></div> <div id="grid"></div>
    <button id="submit" type="button">제출</button>
    <div id="result"></div>
  </body>
  <script>
    const questionDiv = document.getElementById('question');
    const grid = document.getElementById('grid');
    const resultDiv = document.getElementById('result');
    const selected = new Set();
    let images = []; // 백엔드로부터 받은 전체 이미지 목록
    let currentQuestionCategory = ''; // 현재 질문 카테고리

    // 페이지 로드 시 /question 엔드포인트에서 질문과 이미지 정보를 가져옴
    fetch('http://localhost:8000/question')
      .then((res) => res.json())
      .then((data) => {
        currentQuestionCategory = data.category;
        images = data.images; // { url: ..., index: ... } 형태의 배열

        questionDiv.textContent = `${currentQuestionCategory}를 모두 고르세요.`; // 질문 표시

        images.forEach((img) => { // img 객체에는 이제 index도 포함되어 있음
          const div = document.createElement('div');
          div.className = 'tile';
          div.style.backgroundImage = `url(http://localhost:8000${img.url})`;
          div.dataset.index = img.index; // 백엔드에서 받은 인덱스를 그대로 사용

          div.addEventListener('click', () => {
            const index = parseInt(div.dataset.index); // 데이터셋에서 인덱스 파싱
            if (selected.has(index)) {
              selected.delete(index);
              div.classList.remove('selected');
            } else {
              selected.add(index);
              div.classList.add('selected');
            }
          });

          grid.appendChild(div);
        });
      })
      .catch(error => {
          console.error('Error fetching question:', error);
          questionDiv.textContent = '질문을 가져오는 데 실패했습니다.';
      });

    document.getElementById('submit').addEventListener('click', async (event) => {
      event.preventDefault(); // 페이지 새로고침 방지

      const selectedArray = Array.from(selected);
      const res = await fetch('http://localhost:8000/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          images: images,
          selected: selectedArray,
          category_asked: currentQuestionCategory // 현재 질문 카테고리도 함께 보냄
        }),
      });
      const data = await res.json();
      resultDiv.textContent = data.is_correct ? '✅ 정답입니다!' : '❌ 다시 시도해보세요.';

      // 제출 후 상태 초기화 (선택 초기화, 새 질문 시작 등)
      selected.clear();
      document.querySelectorAll('.tile').forEach(tile => {
          tile.classList.remove('selected');
      });
      // 필요하다면, 새 질문을 가져오도록 페이지를 새로고침하지 않고 다시 fetch('/question') 호출
    });
  </script>
</html>