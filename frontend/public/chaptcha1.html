<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>first type</title>
    <style>
      .wrapper {
        min-height: 100vh;
        display:flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 4px;
      }

      #grid {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        gap: 10px;
      }
      .tile {
        width: 100px;
        aspect-ratio: 1/1;
        border: 2px solid gray;
        background-size: cover;
        background-position: center;
        cursor: pointer;
        position: relative;
      }
      .selected {
        border: 2px solid green;
        box-shadow: inset 0 0 0 4px rgba(0, 255, 0, 0.5);
      }
      #question {
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
    <div id="question"></div>
    <div id="grid"></div>
    <button id="submit" type="button">제출</button>
    <div id="result"></div>
    </div>
  </body>
  <script>
    const questionDiv = document.getElementById('question');
    const grid = document.getElementById('grid');
    const resultDiv = document.getElementById('result');
    const selected = new Set();
    let images = []; // 백엔드로부터 받은 전체 이미지 목록
    let currentQuestionCategory = '';
    let count = 0;

    // 질문 및 이미지 가져오기 함수
    async function fetchQuestion() {
      try {
        const res = await fetch('https://port-0-rwcaptcha-mdxb7ic7d809530c.sel5.cloudtype.app/first/question');
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();

        currentQuestionCategory = data.category;
        images = data.images;

        questionDiv.textContent = `${currentQuestionCategory}를 모두 고르세요.`;
        grid.innerHTML = ''; // 기존 이미지 모두 제거

        images.forEach((img, i) => {
          const div = document.createElement('div');
          div.className = 'tile';
          div.style.backgroundImage = `url(https://rwstatic.netlify.app${img.url})`;
          div.dataset.index = i; // 프론트엔드 인덱스

          div.addEventListener('click', () => {
            const index = parseInt(div.dataset.index);
            if (selected.has(index)) {
              selected.delete(index);
              div.classList.remove('selected');
            } else {
              selected.add(index);
              div.classList.add('selected');
            }
          });
          grid.appendChild(div);
        });
        resultDiv.textContent = ''; // 결과 메시지 초기화
        count = 0;
      } catch (error) {
        console.error('Error fetching question:', error);
        questionDiv.textContent = '질문을 가져오는 데 실패했습니다.';
      }
    }

    // 페이지 로드 시 첫 질문 가져오기
    fetchQuestion();

    document.getElementById('submit').addEventListener('click', async (event) => {
      event.preventDefault(); // 페이지 새로고침 방지

      const selectedArray = Array.from(selected);
      const res = await fetch('https://port-0-rwcaptcha-mdxb7ic7d809530c.sel5.cloudtype.app/first/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          images: images, // 백엔드에서 받은 이미지 정보
          selected: selectedArray, // 사용자가 선택한 인덱스
          category_asked: currentQuestionCategory // 현재 질문 카테고리
        }),
      });
      const data = await res.json();
      resultDiv.textContent = data.is_correct ? '정답입니다!' : '다시 시도해보세요.';
      count++;

      // 제출 후 상태 초기화 (선택 초기화)
      selected.clear();
      document.querySelectorAll('.tile').forEach(tile => {
        tile.classList.remove('selected');
      });

      // 오답일 경우 다음 문제로 자동으로 이동
      if (data.is_correct || count >= 2) {
        setTimeout(() => {
          fetchQuestion(); // 새 질문 가져오기
        }, 2000); // 2초 후에 새 질문 로드 (사용자가 결과 메시지를 볼 시간 제공)
      }
    });
  </script>
</html>